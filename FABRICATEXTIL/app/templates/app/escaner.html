{% extends "app/base.html" %}
{% load static %}

{% block title %}Escanear Producto{% endblock %}

{% block content %}
<div class="container fade-in-up mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">

            <div class="card-modern bg-white shadow-lg border-0 overflow-hidden">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-qr-code-scan me-2"></i> Escáner Rápido</h5>
                </div>

                <div class="card-body p-0 position-relative bg-black" style="min-height: 400px;">
                    <video id="scan-video"
                           class="w-100 h-100"
                           style="object-fit: cover; position: absolute; top: 0; left: 0;"
                           playsinline
                           muted
                           autoplay></video>

                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center pointer-events-none">
                        <div style="width: 250px; height: 250px; border: 4px solid rgba(255, 255, 255, 0.7); border-radius: 15px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);"></div>
                    </div>

                    <div id="loading-msg" class="position-absolute top-50 start-50 translate-middle text-white text-center">
                        <div class="spinner-border text-light mb-2"></div>
                        <p class="small">Iniciando cámara...</p>
                    </div>
                </div>

                <div class="card-footer bg-white p-3 text-center z-index-1">
                    <div id="scan-result" class="text-muted small mb-3 fw-bold">Buscando código...</div>
                    <a href="{% url 'app:lista_productos' %}" class="btn btn-outline-danger rounded-pill w-100">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                </div>
            </div>

            <div class="text-center mt-3">
                <button id="switch-cam" class="btn btn-sm btn-dark rounded-pill shadow-sm" style="display: none;">
                    <i class="bi bi-arrow-repeat"></i> Cambiar Cámara
                </button>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import QrScanner from 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js';

    // Configuración del Worker para rendimiento
    QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';

    const videoElem = document.getElementById('scan-video');
    const resultElem = document.getElementById('scan-result');
    const loadingMsg = document.getElementById('loading-msg');
    const switchBtn = document.getElementById('switch-cam');

    let qrScanner;

    // Función que se ejecuta al detectar un código
    const setResult = (result) => {
        console.log('Resultado Crudo:', result);
        qrScanner.stop();

        resultElem.className = "text-success fw-bold mb-3";
        resultElem.innerHTML = `<i class="bi bi-check-circle-fill"></i> ¡Producto encontrado!`;
        if (navigator.vibrate) navigator.vibrate(200);

        // Obtenemos el texto del QR
        let codigoLeido = result.data || result;

        // --- LÓGICA DE LIMPIEZA MEJORADA ---
        if (codigoLeido.includes('http')) {
            // 1. Quitar barra final si existe
            if (codigoLeido.endsWith('/')) codigoLeido = codigoLeido.slice(0, -1);

            // 2. Separar la URL por las barras '/'
            const partes = codigoLeido.split('/');

            // 3. Revisar la última parte
            const ultimaParte = partes[partes.length - 1];

            // Lista de palabras que NO son el SKU
            const palabrasBasura = ['accion', 'accionar', 'editar', 'kiosco', 'delete', 'detail'];

            if (palabrasBasura.includes(ultimaParte)) {
                // Si termina en "accionar", tomamos el PENÚLTIMO elemento (que debería ser el SKU)
                codigoLeido = partes[partes.length - 2];
            } else {
                // Si no termina en basura, tomamos el último elemento normalmente
                codigoLeido = ultimaParte;
            }
        }

        console.log("SKU Limpio:", codigoLeido);

        setTimeout(() => {
            // REDIRECCIÓN A LA VISTA KIOSCO CON EL SKU LIMPIO
            window.location.href = `/inventario/kiosco/${codigoLeido}/`;
        }, 300);
    };

    // Iniciar escáner al cargar la página
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            qrScanner = new QrScanner(
                videoElem,
                result => setResult(result),
                {
                    preferredCamera: 'environment', // Preferir cámara trasera
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                }
            );

            await qrScanner.start();

            // Ocultar spinner de carga
            loadingMsg.style.display = 'none';

            // Mostrar botón de cambiar cámara si hay más de una
            const cameras = await QrScanner.listCameras(true);
            if (cameras.length > 1) {
                switchBtn.style.display = 'inline-block';
            }

        } catch (e) {
            console.error(e);
            loadingMsg.innerHTML = `<span class="text-danger">Error: ${e}</span>`;
        }
    });

    // Evento del botón cambiar cámara
    if (switchBtn) {
        switchBtn.addEventListener('click', () => {
            if (qrScanner) {
                qrScanner.setCamera('next');
            }
        });
    }

    // Limpieza de recursos al salir
    window.addEventListener('beforeunload', () => {
        if (qrScanner) qrScanner.destroy();
    });
</script>
{% endblock %}