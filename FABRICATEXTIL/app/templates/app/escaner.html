<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear Código QR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm text-center">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0"><i class="bi bi-qr-code-scan"></i> Escanear Código de Producto</h2>
                    </div>
                    <div class="card-body">
                        <p class="lead">La cámara se activará automáticamente. Apunta al código QR.</p>

                        <video id="preview" style="width: 100%; border-radius: 8px;"></video>

                        <div id="result" class="mt-3"></div>
                    </div>
                </div>
                <a href="{% url 'lista_de_productos' %}" class="btn btn-secondary mt-3 w-100">Volver a la Lista</a>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Creamos un nuevo objeto escáner y le decimos que use el elemento <video>
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

        // Esta función se ejecuta cuando el escáner detecta un QR
        scanner.addListener('scan', function (content) {
            const resultDiv = document.getElementById('result');
            if (resultDiv) {
                resultDiv.innerHTML = `<div class="alert alert-success mt-3">¡Éxito! SKU: ${content}. Redirigiendo...</div>`;
            }
            // Detenemos la cámara
            scanner.stop();
            // Redirigimos a la página del producto
            window.location.href = `/inventario/producto/${content}/`;
        });

        // Buscamos las cámaras disponibles en el dispositivo
        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                // Si hay cámaras, empezamos a escanear con la primera que encuentre
                scanner.start(cameras[0]);
            } else {
                console.error('No se encontraron cámaras.');
                const resultDiv = document.getElementById('result');
                if (resultDiv) resultDiv.innerHTML = `<div class="alert alert-danger mt-3">No se encontraron cámaras en este dispositivo.</div>`;
            }
        }).catch(function (e) {
            console.error(e);
            const resultDiv = document.getElementById('result');
            if (resultDiv) resultDiv.innerHTML = `<div class="alert alert-danger mt-3">Error al acceder a la cámara. Asegúrate de darle permiso.</div>`;
        });
    </script>
</body>
</html>