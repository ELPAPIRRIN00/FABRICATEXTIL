{% block scripts %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const statusMsg = document.getElementById('status-message');

        // 1. Verificación de seguridad
        if (typeof Html5QrcodeScanner === 'undefined') {
            statusMsg.innerHTML = '<span class="text-danger fw-bold">Error: Librería no cargada. Revisa tu conexión.</span>';
            return;
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Código escaneado: ${decodedText}`);
            html5QrcodeScanner.clear();

            statusMsg.innerHTML = '<span class="text-success fw-bold">¡Código detectado! Procesando...</span>';

            // Lógica de redirección inteligente
            if (decodedText.startsWith('http')) {
                window.location.href = decodedText;
            } else {
                // Ajusta esta URL a tu buscador
                const baseUrl = "{% url 'app:lista_productos' %}";
                window.location.href = `${baseUrl}?q=${decodedText}`;
            }
        }

        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
        }

        // 2. CONFIGURACIÓN CORREGIDA PARA MOVILES
        let config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            // ESTO ES LO NUEVO: Forzamos la cámara trasera
            videoConstraints: {
                facingMode: "environment"
            }
        };

        // 3. Iniciar
        try {
            var html5QrcodeScanner = new Html5QrcodeScanner("reader", config, false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            statusMsg.innerText = "Cámara activa. Apunta al código.";
        } catch (e) {
            statusMsg.innerHTML = '<span class="text-danger">Error: ' + e.message + '</span>';
        }
    });
</script>
{% endblock %}