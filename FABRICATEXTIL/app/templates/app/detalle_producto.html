{% extends "app/base.html" %}
{% load static %}
{% block title %}Detalle: {{ producto.nombre_tela }}{% endblock %}

{% block content %}
<div class="fade-in-up">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'app:lista_productos' %}" class="btn btn-light rounded-pill shadow-sm text-muted fw-bold">
            <i class="bi bi-arrow-left me-2"></i> Volver
        </a>

        <div class="d-flex gap-2">
            <a href="{% url 'app:editar_producto' sku=producto.sku %}" class="btn btn-outline-warning rounded-circle shadow-sm" title="Editar">
                <i class="bi bi-pencil-fill"></i>
            </a>
            <a href="{% url 'app:eliminar_producto' sku=producto.sku %}" class="btn btn-outline-danger rounded-circle shadow-sm" title="Eliminar">
                <i class="bi bi-trash-fill"></i>
            </a>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-lg-8">
            <div class="card-modern bg-white p-4 h-100 shadow-lg border-0">

                <div class="d-flex align-items-start justify-content-between mb-4 border-bottom pb-3">
                    <div>
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-1 mb-2">
                            {{ producto.get_tipo_display }}
                        </span>
                        <h2 class="fw-bold text-dark mb-0">{{ producto.nombre_tela }}</h2>
                        <p class="text-muted small mb-0 font-monospace">SKU: {{ producto.sku }}</p>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-light text-dark p-2 rounded-3 border">
                            <i class="bi bi-palette-fill me-1 text-secondary"></i> {{ producto.color }}
                        </div>
                    </div>
                </div>

                <h6 class="text-uppercase text-muted fw-bold small mb-3 ls-1">Especificaciones Técnicas</h6>
                <div class="row g-3 mb-5">
                    <div class="col-sm-6 col-md-4">
                        <div class="p-3 bg-light rounded-3 border h-100">
                            <small class="text-muted d-block mb-1">Dimensiones</small>
                            <span class="fw-bold text-dark">{{ producto.largo }}m x {{ producto.ancho }}m</span>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4">
                        <div class="p-3 bg-light rounded-3 border h-100">
                            <small class="text-muted d-block mb-1">Peso Unitario</small>
                            <span class="fw-bold text-dark">{{ producto.peso_por_pieza }} kg</span>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4">
                        <div class="p-3 bg-light rounded-3 border h-100">
                            <small class="text-muted d-block mb-1">Composición</small>
                            <span class="fw-bold text-dark">{{ producto.composicion|default:"-" }}</span>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="p-3 bg-primary-subtle rounded-3 border border-primary border-opacity-25 d-flex justify-content-around flex-wrap gap-2 text-center">
                            <div>
                                <small class="text-primary d-block fw-bold opacity-75">Paquete</small>
                                <span class="fw-bold text-dark">{{ producto.paquete_pz|default:"0" }} pz</span>
                            </div>
                            <div class="vr bg-primary opacity-25"></div>
                            <div>
                                <small class="text-primary d-block fw-bold opacity-75">Bulto</small>
                                <span class="fw-bold text-dark">{{ producto.paquetes_bulto|default:"0" }} pq</span>
                            </div>
                            <div class="vr bg-primary opacity-25"></div>
                            <div>
                                <small class="text-primary d-block fw-bold opacity-75">Total Bulto</small>
                                <span class="fw-bold text-dark">{{ producto.bulto_pz|default:"0" }} pz</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="p-3 border rounded-3 bg-white">
                            <div class="mb-2">
                                <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                                <span class="fw-bold text-dark">{{ producto.ubicacion|default:"Sin ubicación asignada" }}</span>
                            </div>
                            {% if producto.descripcion %}
                            <div class="d-flex align-items-start text-muted small">
                                <i class="bi bi-card-text me-2 mt-1"></i>
                                <em>{{ producto.descripcion }}</em>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <h6 class="text-uppercase text-muted fw-bold small mb-3 ls-1">Accesos Digitales</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border rounded-4 p-3 d-flex align-items-center gap-3 bg-white h-100 position-relative overflow-hidden group-hover-zoom">
                            <div class="qr-canvas-wrapper">
                                <div id="qr-info" class="qr-canvas" data-url="{{ url_qr_info }}"></div>
                            </div>
                            <div>
                                <h6 class="fw-bold text-dark mb-1">QR Estante</h6>
                                <p class="text-muted small mb-0 lh-sm">Ficha técnica informativa.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border border-primary border-opacity-50 rounded-4 p-3 d-flex align-items-center gap-3 bg-primary-subtle h-100 position-relative overflow-hidden group-hover-zoom">
                            <div class="qr-canvas-wrapper bg-white p-1 rounded">
                                <div id="qr-accion" class="qr-canvas" data-url="{{ url_qr_accion }}"></div>
                            </div>
                            <div>
                                <h6 class="fw-bold text-primary mb-1">QR Acción</h6>
                                <p class="text-primary opacity-75 small mb-0 lh-sm">Escaneo para E/S rápida.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="col-lg-4">

            <div class="card-modern bg-white p-4 shadow-lg border-0 mb-4 text-center position-relative overflow-hidden">
                <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient-primary opacity-10"></div>

                <h6 class="text-uppercase text-muted mb-2 fw-bold ls-1 position-relative">Stock Actual</h6>
                <div class="display-3 fw-bold text-primary mb-0 position-relative lh-1">{{ producto.pz }}</div>
                <small class="text-muted position-relative">Piezas Totales</small>

                <hr class="my-4 opacity-10">

                <div class="d-grid gap-2 position-relative">
                    <a href="{% url 'app:registrar_entrada' producto_sku=producto.sku %}" class="btn btn-success fw-bold py-2 shadow-sm border-0">
                        <i class="bi bi-plus-lg me-2"></i> Entrada Manual
                    </a>
                    <a href="{% url 'app:registrar_salida' producto_sku=producto.sku %}" class="btn btn-danger fw-bold py-2 shadow-sm border-0">
                        <i class="bi bi-dash-lg me-2"></i> Salida Manual
                    </a>
                </div>
            </div>

            <div class="card-modern bg-white p-4 shadow-lg border-0 h-auto">
                <h6 class="text-uppercase text-muted mb-4 fw-bold ls-1 border-bottom pb-2">
                    <i class="bi bi-clock-history me-2"></i> Actividad Reciente
                </h6>

                <div class="timeline position-relative">
                    {% for mov in producto.movimientoinventario_set.all|slice:":10" %}
                    <div class="timeline-item pb-4 position-relative ps-4 border-start border-2 border-light">
                        <div class="position-absolute top-0 start-0 translate-middle rounded-circle border border-2 border-white shadow-sm
                            {% if mov.tipo_movimiento == 'ENTRADA' %}bg-success{% else %}bg-danger{% endif %}"
                             style="width: 12px; height: 12px; left: -1px; margin-top: 5px;">
                        </div>

                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge {% if mov.tipo_movimiento == 'ENTRADA' %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} mb-1 border-0 fw-bold" style="font-size: 0.65rem;">
                                    {{ mov.tipo_movimiento }}
                                </span>
                                <div class="small text-dark fw-semibold">
                                    <i class="bi bi-person me-1 text-muted"></i> {{ mov.usuario.username|default:"Sistema" }}
                                </div>
                                <div class="text-muted fst-italic" style="font-size: 0.75rem;">
                                    {{ mov.notas|default:"-"|truncatechars:20 }}
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="d-block fw-bold text-dark fs-6">
                                    {% if mov.tipo_movimiento == 'ENTRADA' %}+{% else %}-{% endif %}{{ mov.cantidad }}
                                </span>
                                <small class="text-muted fw-medium" style="font-size: 0.65rem;">{{ mov.fecha|date:"d/m H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-muted small">
                        Sin movimientos registrados.
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>

</div>

<style>
    /* Timeline minimalista */
    .timeline .timeline-item:last-child {
        border-left: 0 !important;
        padding-bottom: 0 !important;
    }

    /* Espaciado de letras */
    .ls-1 {
        letter-spacing: 1px;
    }

    /* Fondo sutil */
    .bg-primary-subtle {
        background-color: #e0e7ff !important;
        color: #3730a3 !important;
    }

    .bg-success-subtle {
        background-color: #dcfce7 !important;
        color: #166534 !important;
    }

    .bg-danger-subtle {
        background-color: #fee2e2 !important;
        color: #991b1b !important;
    }

    /* Gradiente para stock */
    .bg-gradient-primary {
        background: linear-gradient(135deg, var(--primary-color), #818cf8);
    }

    /* Ajuste de QR */
    .qr-canvas {
        width: 80px;
        height: 80px;
    }

        .qr-canvas img, .qr-canvas canvas {
            width: 100%;
            height: auto;
        }

    /* Animación de entrada */
    .fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function generarQR(elementoId) {
            const el = document.getElementById(elementoId);
            if (el) {
                const url = el.dataset.url;
                if (url) {
                    // Limpiar contenido previo si existe
                    el.innerHTML = "";
                    new QRCode(el, {
                        text: url,
                        width: 100,
                        height: 100,
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            }
        }
        generarQR('qr-info');
        generarQR('qr-accion');
    });
</script>
{% endblock %}